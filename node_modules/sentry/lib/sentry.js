// Generated by CoffeeScript 1.3.3
(function() {
  var exec, fileUtil, fs, path, watchFile, _,
    _this = this;

  fileUtil = require('file');

  _ = require('underscore');

  fs = require('fs');

  exec = require('child_process').exec;

  path = require('path');

  this.watch = function(file, task, callback) {
    var files, _i, _len, _results;
    if (_.isFunction(task)) {
      callback = task;
    }
    if (file.indexOf('/*') !== -1) {
      files = _this.findWildcards(file);
      _results = [];
      for (_i = 0, _len = files.length; _i < _len; _i++) {
        file = files[_i];
        _results.push(watchFile(file, task, callback));
      }
      return _results;
    } else {
      if (!path.existsSync(file)) {
        throw new Error("SENTRY: File '" + file + "' does not exist!");
      }
      return watchFile(file, task, callback);
    }
  };

  this.watchRegExp = function(root, regex, task, callback) {
    var file, files, _i, _len, _results;
    if (_.isFunction(task)) {
      callback = task;
    }
    root = path.resolve(path.dirname(module.parent.filename), root);
    files = [];
    fileUtil.walkSync(root, function(rt, flds, fls) {
      var fl, flPath, _i, _len, _results;
      _results = [];
      for (_i = 0, _len = fls.length; _i < _len; _i++) {
        fl = fls[_i];
        flPath = rt + '/' + fl;
        if (flPath.match(regex)) {
          _results.push(files.push(flPath));
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    });
    files;

    _results = [];
    for (_i = 0, _len = files.length; _i < _len; _i++) {
      file = files[_i];
      _results.push(watchFile(file, task, callback));
    }
    return _results;
  };

  watchFile = function(file, task, callback) {
    return fs.watchFile(file, function(curr, prev) {
      if (curr.size === prev.size && curr.mtime.getTime() === prev.mtime.getTime()) {
        return;
      }
      if (_.isString(task)) {
        return exec(task, function(err, stdout, stderr) {
          console.log(stdout);
          if (err != null) {
            console.log(err);
          }
          if (callback != null) {
            return callback(err, stdout, stderr);
          }
        });
      } else {
        return callback(file);
      }
    });
  };

  this.findWildcards = function(file) {
    var ext, files, root, _i, _len, _ref;
    files = [];
    if ((file != null) && file.indexOf('**/*') !== -1) {
      root = file.split('**/*')[0];
      ext = file.split('**/*')[1];
      fileUtil.walkSync(root, function(root, flds, fls) {
        var _i, _len, _results;
        root = (root.charAt(root.length - 1) === '/' ? root : root + '/');
        _results = [];
        for (_i = 0, _len = fls.length; _i < _len; _i++) {
          file = fls[_i];
          if ((file.match(new RegExp(ext + '$')) != null) && _.indexOf(files, root + file) === -1) {
            _results.push(files.push(root + file));
          } else {
            _results.push(void 0);
          }
        }
        return _results;
      });
    } else if ((file != null) && file.indexOf('/*') !== -1) {
      root = file.split('/*')[0];
      ext = file.split('/*')[1];
      _ref = fs.readdirSync(root);
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        file = _ref[_i];
        if (file.indexOf('.') !== -1 && (file.match(new RegExp(ext + '$')) != null) && _.indexOf(files, root + '/' + file) === -1) {
          files.push(root + '/' + file);
        }
      }
    }
    return files;
  };

}).call(this);
